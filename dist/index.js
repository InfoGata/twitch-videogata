class S extends Error{response;request;options;constructor(t,s,r){const o=t.status||t.status===0?t.status:"",n=t.statusText||"",a=`${o} ${n}`.trim(),i=a?`status code ${a}`:"an unknown error";super(`Request failed with ${i}: ${s.method} ${s.url}`),this.name="HTTPError",this.response=t,this.request=s,this.options=r}}class j extends Error{request;constructor(t){super(`Request timed out: ${t.method} ${t.url}`),this.name="TimeoutError",this.request=t}}const _=e=>e!==null&&typeof e=="object",w=(...e)=>{for(const t of e)if((!_(t)||Array.isArray(t))&&t!==void 0)throw new TypeError("The `options` argument must be an object");return E({},...e)},P=(e={},t={})=>{const s=new globalThis.Headers(e),r=t instanceof globalThis.Headers,o=new globalThis.Headers(t);for(const[n,a]of o.entries())r&&a==="undefined"||a===void 0?s.delete(n):s.set(n,a);return s};function g(e,t,s){return Object.hasOwn(t,s)&&t[s]===void 0?[]:E(e[s]??[],t[s]??[])}const x=(e={},t={})=>({beforeRequest:g(e,t,"beforeRequest"),beforeRetry:g(e,t,"beforeRetry"),afterResponse:g(e,t,"afterResponse"),beforeError:g(e,t,"beforeError")}),E=(...e)=>{let t={},s={},r={};for(const o of e)if(Array.isArray(o))Array.isArray(t)||(t=[]),t=[...t,...o];else if(_(o)){for(let[n,a]of Object.entries(o))_(a)&&n in t&&(a=E(t[n],a)),t={...t,[n]:a};_(o.hooks)&&(r=x(r,o.hooks),t.hooks=r),_(o.headers)&&(s=P(s,o.headers),t.headers=s)}return t},D=(()=>{let e=!1,t=!1;const s=typeof globalThis.ReadableStream=="function",r=typeof globalThis.Request=="function";if(s&&r)try{t=new globalThis.Request("https://empty.invalid",{body:new globalThis.ReadableStream,method:"POST",get duplex(){return e=!0,"half"}}).headers.has("Content-Type")}catch(o){if(o instanceof Error&&o.message==="unsupported BodyInit type")return!1;throw o}return e&&!t})(),H=typeof globalThis.AbortController=="function",B=typeof globalThis.ReadableStream=="function",F=typeof globalThis.FormData=="function",$=["get","post","put","patch","head","delete"],V={json:"application/json",text:"text/*",formData:"multipart/form-data",arrayBuffer:"*/*",blob:"*/*"},T=2147483647,L=Symbol("stop"),W={json:!0,parseJson:!0,stringifyJson:!0,searchParams:!0,prefixUrl:!0,retry:!0,timeout:!0,hooks:!0,throwHttpErrors:!0,onDownloadProgress:!0,fetch:!0},J={method:!0,headers:!0,body:!0,mode:!0,credentials:!0,cache:!0,redirect:!0,referrer:!0,referrerPolicy:!0,integrity:!0,keepalive:!0,signal:!0,window:!0,dispatcher:!0,duplex:!0,priority:!0},z=e=>$.includes(e)?e.toUpperCase():e,Q=["get","put","head","delete","options","trace"],Y=[408,413,429,500,502,503,504],G=[413,429,503],C={limit:2,methods:Q,statusCodes:Y,afterStatusCodes:G,maxRetryAfter:Number.POSITIVE_INFINITY,backoffLimit:Number.POSITIVE_INFINITY,delay:e=>.3*2**(e-1)*1e3},K=(e={})=>{if(typeof e=="number")return{...C,limit:e};if(e.methods&&!Array.isArray(e.methods))throw new Error("retry.methods must be an array");if(e.statusCodes&&!Array.isArray(e.statusCodes))throw new Error("retry.statusCodes must be an array");return{...C,...e}};async function X(e,t,s,r){return new Promise((o,n)=>{const a=setTimeout(()=>{s&&s.abort(),n(new j(e))},r.timeout);r.fetch(e,t).then(o).catch(n).then(()=>{clearTimeout(a)})})}async function Z(e,{signal:t}){return new Promise((s,r)=>{t&&(t.throwIfAborted(),t.addEventListener("abort",o,{once:!0}));function o(){clearTimeout(n),r(t.reason)}const n=setTimeout(()=>{t?.removeEventListener("abort",o),s()},e)})}const tt=(e,t)=>{const s={};for(const r in t)!(r in J)&&!(r in W)&&!(r in e)&&(s[r]=t[r]);return s};class R{static create(t,s){const r=new R(t,s),o=async()=>{if(typeof r._options.timeout=="number"&&r._options.timeout>T)throw new RangeError(`The \`timeout\` option cannot be greater than ${T}`);await Promise.resolve();let i=await r._fetch();for(const h of r._options.hooks.afterResponse){const c=await h(r.request,r._options,r._decorateResponse(i.clone()));c instanceof globalThis.Response&&(i=c)}if(r._decorateResponse(i),!i.ok&&r._options.throwHttpErrors){let h=new S(i,r.request,r._options);for(const c of r._options.hooks.beforeError)h=await c(h);throw h}if(r._options.onDownloadProgress){if(typeof r._options.onDownloadProgress!="function")throw new TypeError("The `onDownloadProgress` option must be a function");if(!B)throw new Error("Streams are not supported in your environment. `ReadableStream` is missing.");return r._stream(i.clone(),r._options.onDownloadProgress)}return i},a=r._options.retry.methods.includes(r.request.method.toLowerCase())?r._retry(o):o();for(const[i,h]of Object.entries(V))a[i]=async()=>{r.request.headers.set("accept",r.request.headers.get("accept")||h);const c=await a;if(i==="json"){if(c.status===204||(await c.clone().arrayBuffer()).byteLength===0)return"";if(s.parseJson)return s.parseJson(await c.text())}return c[i]()};return a}request;abortController;_retryCount=0;_input;_options;constructor(t,s={}){if(this._input=t,this._options={...s,headers:P(this._input.headers,s.headers),hooks:x({beforeRequest:[],beforeRetry:[],beforeError:[],afterResponse:[]},s.hooks),method:z(s.method??this._input.method??"GET"),prefixUrl:String(s.prefixUrl||""),retry:K(s.retry),throwHttpErrors:s.throwHttpErrors!==!1,timeout:s.timeout??1e4,fetch:s.fetch??globalThis.fetch.bind(globalThis)},typeof this._input!="string"&&!(this._input instanceof URL||this._input instanceof globalThis.Request))throw new TypeError("`input` must be a string, URL, or Request");if(this._options.prefixUrl&&typeof this._input=="string"){if(this._input.startsWith("/"))throw new Error("`input` must not begin with a slash when using `prefixUrl`");this._options.prefixUrl.endsWith("/")||(this._options.prefixUrl+="/"),this._input=this._options.prefixUrl+this._input}if(H){this.abortController=new globalThis.AbortController;const r=this._options.signal??this._input.signal;r?.aborted&&this.abortController.abort(r?.reason),r?.addEventListener("abort",()=>{this.abortController.abort(r.reason)}),this._options.signal=this.abortController.signal}if(D&&(this._options.duplex="half"),this._options.json!==void 0&&(this._options.body=this._options.stringifyJson?.(this._options.json)??JSON.stringify(this._options.json),this._options.headers.set("content-type",this._options.headers.get("content-type")??"application/json")),this.request=new globalThis.Request(this._input,this._options),this._options.searchParams){const o="?"+(typeof this._options.searchParams=="string"?this._options.searchParams.replace(/^\?/,""):new URLSearchParams(this._options.searchParams).toString()),n=this.request.url.replace(/(?:\?.*?)?(?=#|$)/,o);(F&&this._options.body instanceof globalThis.FormData||this._options.body instanceof URLSearchParams)&&!(this._options.headers&&this._options.headers["content-type"])&&this.request.headers.delete("content-type"),this.request=new globalThis.Request(new globalThis.Request(n,{...this.request}),this._options)}}_calculateRetryDelay(t){if(this._retryCount++,this._retryCount>this._options.retry.limit||t instanceof j)throw t;if(t instanceof S){if(!this._options.retry.statusCodes.includes(t.response.status))throw t;const r=t.response.headers.get("Retry-After")??t.response.headers.get("RateLimit-Reset")??t.response.headers.get("X-RateLimit-Reset")??t.response.headers.get("X-Rate-Limit-Reset");if(r&&this._options.retry.afterStatusCodes.includes(t.response.status)){let o=Number(r)*1e3;Number.isNaN(o)?o=Date.parse(r)-Date.now():o>=Date.parse("2024-01-01")&&(o-=Date.now());const n=this._options.retry.maxRetryAfter??o;return o<n?o:n}if(t.response.status===413)throw t}const s=this._options.retry.delay(this._retryCount);return Math.min(this._options.retry.backoffLimit,s)}_decorateResponse(t){return this._options.parseJson&&(t.json=async()=>this._options.parseJson(await t.text())),t}async _retry(t){try{return await t()}catch(s){const r=Math.min(this._calculateRetryDelay(s),T);if(this._retryCount<1)throw s;await Z(r,{signal:this._options.signal});for(const o of this._options.hooks.beforeRetry)if(await o({request:this.request,options:this._options,error:s,retryCount:this._retryCount})===L)return;return this._retry(t)}}async _fetch(){for(const r of this._options.hooks.beforeRequest){const o=await r(this.request,this._options);if(o instanceof Request){this.request=o;break}if(o instanceof Response)return o}const t=tt(this.request,this._options),s=this.request;return this.request=s.clone(),this._options.timeout===!1?this._options.fetch(s,t):X(s,t,this.abortController,this._options)}_stream(t,s){const r=Number(t.headers.get("content-length"))||0;let o=0;return t.status===204?(s&&s({percent:1,totalBytes:r,transferredBytes:o},new Uint8Array),new globalThis.Response(null,{status:t.status,statusText:t.statusText,headers:t.headers})):new globalThis.Response(new globalThis.ReadableStream({async start(n){const a=t.body.getReader();s&&s({percent:0,transferredBytes:0,totalBytes:r},new Uint8Array);async function i(){const{done:h,value:c}=await a.read();if(h){n.close();return}if(s){o+=c.byteLength;const y=r===0?0:o/r;s({percent:y,transferredBytes:o,totalBytes:r},c)}n.enqueue(c),await i()}await i()}}),{status:t.status,statusText:t.statusText,headers:t.headers})}}/*! MIT License Â© Sindre Sorhus */const q=e=>{const t=(s,r)=>R.create(s,w(e,r));for(const s of $)t[s]=(r,o)=>R.create(r,w(e,o,{method:s}));return t.create=s=>q(w(s)),t.extend=s=>(typeof s=="function"&&(s=s(e??{})),q(w(e,s))),t.stop=L,t},et=q();var k={},I;function st(){return I||(I=1,function(e){Object.defineProperty(e,"__esModule",{value:!0}),e.toSeconds=e.end=e.parse=e.pattern=void 0;var t="\\d+",s="".concat(t,"(?:[\\.,]").concat(t,")?"),r="(".concat(t,"Y)?(").concat(t,"M)?(").concat(t,"W)?(").concat(t,"D)?"),o="T(".concat(s,"H)?(").concat(s,"M)?(").concat(s,"S)?"),n="P(?:".concat(r,"(?:").concat(o,")?)"),a=["years","months","weeks","days","hours","minutes","seconds"],i=Object.freeze({years:0,months:0,weeks:0,days:0,hours:0,minutes:0,seconds:0});e.pattern=new RegExp(n);var h=function(f){var p=f.replace(/,/g,".").match(e.pattern);if(!p)throw new RangeError("invalid duration: ".concat(f));var l=p.slice(1);if(l.filter(function(d){return d!=null}).length===0)throw new RangeError("invalid duration: ".concat(f));if(l.filter(function(d){return/\./.test(d||"")}).length>1)throw new RangeError("only the smallest unit can be fractional");return l.reduce(function(d,u,b){return d[a[b]]=parseFloat(u||"0")||0,d},{})};e.parse=h;var c=function(f,p){p===void 0&&(p=new Date);var l=Object.assign({},i,f),d=p.getTime(),u=new Date(d);u.setFullYear(u.getFullYear()+l.years),u.setMonth(u.getMonth()+l.months),u.setDate(u.getDate()+l.days);var b=l.hours*3600*1e3,v=l.minutes*60*1e3;return u.setMilliseconds(u.getMilliseconds()+l.seconds*1e3+b+v),u.setDate(u.getDate()+l.weeks*7),u};e.end=c;var y=function(f,p){p===void 0&&(p=new Date);var l=Object.assign({},i,f),d=p.getTime(),u=new Date(d),b=(0,e.end)(l,u),v=(b.getTime()-u.getTime())/1e3;return v};e.toSeconds=y,e.default={end:e.end,toSeconds:e.toSeconds,pattern:e.pattern,parse:e.parse}}(k)),k}var A=st();const U=async e=>{const s=`https://api.twitch.tv/helix/users?login=${e}`;return(await m.get(s).json()).data[0].id},rt="https://cloudflare-worker-token-service.audio-pwa.workers.dev/token",M="19tpyf3jn7o7c05mk774ira19x8bbp",m=et.create({headers:{"Client-Id":M},hooks:{beforeRequest:[e=>{const t=localStorage.getItem("access_token");t&&e.headers.set("Authorization","Bearer "+t)}],afterResponse:[async(e,t,s)=>{if(s.status===401){const r=await ot();return e.headers.set("Authorization","Bearer "+r),m(e)}}]}}),ot=async()=>{const e=new URLSearchParams;e.append("client_id",M),e.append("grant_type","client_credentials");const t=await m.post(rt,{headers:{"Content-Type":"application/x-www-form-urlencoded"},body:e}).json();if(t.access_token)return t.access_token},O=async e=>{const s=`https://api.twitch.tv/helix/search/channels?query=${e.query}`;return{items:(await m.get(s).json()).data.map(n=>({apiId:n.broadcaster_login,name:n.display_name,images:[{url:n.thumbnail_url}],isLive:n.is_live}))}},N=e=>({title:e.title,apiId:e.id,duration:A.toSeconds(A.parse(`PT${e.duration.toUpperCase()}`)),images:[{url:e.thumbnail_url.replace("%{width}","200").replace("%{height}","200"),height:250,width:250}],channelApiId:e.user_login,channelName:e.user_name}),nt=async e=>{const t="https://api.twitch.tv/helix/videos",s="archive",r=await U(e.apiId||""),o=`${t}?user_id=${r}&type=${s}`,a=(await m.get(o).json()).data.map(N),h=`https://api.twitch.tv/helix/streams?user_id=${r}&live=true`,y=(await m.get(h).json()).data.length>0;return{items:a,isLive:y}},at=async e=>{const s=`https://api.twitch.tv/helix/videos?id=${e.apiId}`;return(await m.get(s).json()).data.map(N)[0]},it=async e=>{const t="https://api.twitch.tv/helix/streams",s=await U(e.channelApiId),r=`${t}?user_id=${s}&live=true`,o=await m.get(r).json();if(o.data.length>0)return o.data.map(a=>({title:a.title,channelName:a.user_name,channelApiId:a.user_login}))[0]},ct=async e=>{const t=O(e),[s]=await Promise.all([t]);return{channels:s}};application.onSearchAll=ct;application.onGetChannelVideos=nt;application.onSearchChannels=O;application.onGetVideo=at;application.onGetLiveVideo=it;application.onUiMessage=async e=>{switch(e.type){case"endvideo":application.endVideo();break}};
